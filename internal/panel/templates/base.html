{{define "base"}}<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{if .Title}}{{.Title}} &mdash; {{end}}Opcode</title>
    <link rel="stylesheet" href="/static/css/pico.min.css">
    <link rel="stylesheet" href="/static/css/panel.css">
    <script src="/static/js/htmx.min.js"></script>
    <script src="/static/js/htmx-sse.js"></script>
    <script src="/static/js/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad: true, theme: 'dark', themeVariables: {primaryColor: '#0f3460', primaryBorderColor: '#243b6a', primaryTextColor: '#e8e8e8', lineColor: '#6c7a9b', secondaryColor: '#1e2a4a', tertiaryColor: '#16213e'}});</script>
</head>
<body>
    <nav class="sidebar">
        <div class="sidebar-header">
            <div style="display: flex; align-items: center; gap: 0.6rem;">
                <img src="/static/img/logo.svg" alt="Opcode" style="width: 42px; height: 42px;">
                <h2>Opcode</h2>
            </div>
            <div class="version">workflow orchestration</div>
        </div>
        <ul>
            <li class="{{if eq .Active "dashboard"}}active{{end}}">
                <a href="/"><span class="nav-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg></span> Dashboard</a>
            </li>
            <li class="{{if eq .Active "workflows"}}active{{end}}">
                <a href="/workflows"><span class="nav-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></span> Workflows</a>
            </li>
            <li class="{{if eq .Active "templates"}}active{{end}}">
                <a href="/templates"><span class="nav-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></span> Templates</a>
            </li>
            <li class="{{if eq .Active "decisions"}}active{{end}}">
                <a href="/decisions"><span class="nav-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 3h12l4 6-10 13L2 9z"/></svg></span> Decisions</a>
            </li>
            <li class="{{if eq .Active "scheduler"}}active{{end}}">
                <a href="/scheduler"><span class="nav-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></span> Scheduler</a>
            </li>
            <li class="{{if eq .Active "events"}}active{{end}}">
                <a href="/events"><span class="nav-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span> Events</a>
            </li>
            <li class="{{if eq .Active "agents"}}active{{end}}">
                <a href="/agents"><span class="nav-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></span> Agents</a>
            </li>
        </ul>
        <div style="padding: 0.75rem 1.25rem; border-top: 1px solid var(--op-border);">
            <a href="https://github.com/rendis/opcode" target="_blank" rel="noopener" style="display: flex; align-items: center; gap: 0.5rem; color: var(--op-text-muted); font-size: 0.78rem; transition: color 150ms ease;">
                <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
                GitHub
            </a>
        </div>
    </nav>
    <main class="content">
        {{template "content" .}}
    </main>
    <script>
    document.addEventListener('click', function(e) {
        var row = e.target.closest('tr.clickable');
        if (row && row.dataset.href) {
            window.location = row.dataset.href;
        }
    });
    document.addEventListener('click', function(e) {
        var toggle = e.target.closest('.expandable-toggle');
        if (toggle) {
            toggle.closest('.expandable').classList.toggle('open');
        }
    });
    document.addEventListener('click', function(e) {
        var tab = e.target.closest('.tab');
        if (!tab) return;
        var tabs = tab.closest('.tabs');
        var container = tabs.parentElement;
        tabs.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
        tab.classList.add('active');
        container.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
        var target = container.querySelector('#' + tab.dataset.tab);
        if (target) target.classList.add('active');
    });
    // Close modal on outside click and reset form
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal-overlay') && e.target.classList.contains('open')) {
            e.target.classList.remove('open');
            var form = e.target.querySelector('form');
            if (form) form.reset();
        }
    });

    function confirmAction(msg, url, method) {
        if (confirm(msg)) {
            fetch(url, {method: method || 'POST', headers: {'Content-Type': 'application/json'}})
                .then(function(r) { return r.json(); })
                .then(function() { window.location.reload(); });
        }
    }
    function resolveDecision(e, id) {
        e.preventDefault();
        var form = e.target;
        fetch('/api/decisions/' + id + '/resolve', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                choice: form.choice.value,
                reasoning: form.reasoning.value
            })
        }).then(function(r) {
            if (r.ok) { window.location.reload(); }
            else { r.json().then(function(d) { alert(d.error || 'Error resolving decision'); }); }
        });
        return false;
    }
    </script>
</body>
</html>{{end}}
